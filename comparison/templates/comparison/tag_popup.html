<!DOCTYPE html>
<html lang="ja">
{% load static %}

<head>
  <meta charset="UTF-8">
  <title>タグ一覧</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    ul {
      list-style: none;
      padding-left: 0;
    }

    li {
      margin-bottom: 0.5em;
    }

    a {
      text-decoration: none;
      color: blue;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <h2>タグ一覧</h2>
  <!-- fetch 先の HTML からパースに使うだけ -->
  <div id="all-tags">…</div>

  <!-- ここに renderTagList() が描画する -->
  <ul id="tag-list"></ul>

  <script>
    const tagIndex = {};
    const allTagsUrl = "{{ all_tags_url|escapejs }}";

    async function buildTagIndex() {
      const res = await fetch(allTagsUrl);
      if (!res.ok) {
        console.error('タグ一覧取得失敗:', res.status, res.statusText);
        return;
      }
      const html = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      // 各作品ごとに繰り返し
      doc.querySelectorAll("#all-tags > div[id]").forEach(div => {
        const workId = div.id;
        const rowKey = div.dataset.row;
        const title = div.querySelector("h3")?.textContent.trim() || workId;

        // 作品内のタグリスト(li)を繰り返し
        div.querySelectorAll("li").forEach(li => {
          const strong = li.querySelector("strong");
          if (!strong) return;

          const role = strong.textContent.replace(/:$/, "");
          const name = li.textContent.replace(strong.textContent, "").trim();
          const key = `${role}:${name}`;

          // tagIndex[key] に { id, title, rowKey } を積む
          if (!tagIndex[key]) tagIndex[key] = [];
          tagIndex[key].push({ id: workId, title, rowKey });
        });
      });

      // タグ一覧を描画
      renderTagList();
    }

    function renderTagList() {
      const ul = document.getElementById("tag-list");
      ul.innerHTML = "";
      Object.keys(tagIndex).sort().forEach(tagKey => {
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = "#";
        a.textContent = tagKey;
        a.addEventListener("click", e => {
          e.preventDefault();
          const entries = tagIndex[tagKey];
          if (window.opener && !window.opener.closed) {
            window.opener.showTagResults(tagKey, entries);
            window.close();
          }
        });
        li.appendChild(a);
        ul.appendChild(li);
      });
    }

    document.addEventListener('DOMContentLoaded', buildTagIndex);
  </script>

</body>

</html>