<!DOCTYPE html>
<html lang="ja">
{% load static %}

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>マイページ</title>
  <link rel="stylesheet" href="{% static 'comparison/user_mypage_style/mypage_style.css' %}">
</head>

<body>
  <div class="container">
    <h1 class="username">Welcome, {{ request.user.username }}!</h1>

    <!-- タグ一覧 -->
    <h2 class="your_tag collapsible">あなたのタグ一覧</h2>
    <div class="tag-legend content-section">
      <ul>
        {% for tag in tags %}
        <li id="tag-{{ tag.id }}">
          <strong>{{ tag.role }}:</strong> {{ tag.name }}
          <div class="works">
            適用作品：
            {% for wt in tag.user_work_tags %}
              {% if wt.work.comparison_page and wt.work.id_for_anchor %}
                <a href="{% url 'comparison:comparison_page' page=wt.work.comparison_page %}#{{ wt.work.id_for_anchor }}">
                  {{ wt.work.title }}
                </a>
              {% else %}
                <span>{{ wt.work.title }}</span>
              {% endif %}
              {% if not forloop.last %}, {% endif %}
            {% empty %}
              <span>該当作品なし</span>
            {% endfor %}
          </div>
          {% if tag.user_work_tags %}
          <div class="tag-actions">
            <a href="{% url 'comparison:edit_tag' tag.id %}">編集</a>
            <form method="post" action="{% url 'comparison:delete_tag' tag.id %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit"
                onclick="return confirm('このタグを削除してもよいですか？\n\n注意：このタグを使用している全ての作品から削除されます。');">削除</button>
            </form>
          </div>
          {% endif %}
        </li>
        {% empty %}
        <li>あなたが追加したタグはまだありません。</li>
        {% endfor %}
      </ul>
    </div>

    

    <!-- お気に入り一覧 -->
    <h2 class="your_favorites collapsible">お気に入り作品一覧</h2>
    <div class="favorites-section content-section">
      <label for="sort_favorites">並び替え:</label>
      <!-- ソート切り替え -->
      <div class="mb-3">
        <a href="?sort=added" class="btn btn-outline-primary btn-sm">追加順</a>
        <a href="?sort=title_asc" class="btn btn-outline-primary btn-sm">五十音順（昇順）</a>
        <a href="?sort=title_desc" class="btn btn-outline-primary btn-sm">五十音順（降順）</a>
      </div>
      <ul>
        {% for f in favorites %}
        <li>
          {% if f.work and f.work.id %}
            <a href="{% url 'comparison:work_detail' f.work.id %}">{{ f.work.title }}</a>

            <!-- マイリストへ追加フォーム -->
            <form class="mylist_form" method="post" action="{% url 'comparison:add_to_mylist' f.work.pk %}" style="display:inline;">
              {% csrf_token %}
              <select name="mylist_id">
                {% for mylist in mylists %}
                  <option value="{{ mylist.pk }}">{{ mylist.name }}</option>
                {% endfor %}
              </select>
              <button type="submit" class="btn btn-sm btn-primary">追加</button>
            </form>         

          {% else %}
            <span class="missing-work">（作品情報がありません）</span>
          {% endif %}
        </li>
        {% empty %}
        <li>お気に入りはありません</li>
        {% endfor %}
      </ul>
    </div>

    <!-- マイリスト一覧 -->
    <h2 class="your_mylists collapsible">あなたのマイリスト</h2>
    <div class="mylists-section content-section">
      <a href="{% url 'comparison:mylist_create' %}" class="btn btn-primary">新しいマイリストを作成</a>
      <ul>
        {% for mylist in mylists %}
        <li>
          <a href="{% url 'comparison:mylist_detail' mylist.pk %}">{{ mylist.name }}</a>
          {% if mylist.is_public %}
            
            <span class="badge bg-success">公開</span>
          {% else %}
            <span class="badge bg-secondary">非公開</span>
          {% endif %}
          <!-- 削除リンク -->
          <a href="{% url 'comparison:delete_mylist' mylist.pk %}" class="btn btn-sm btn-danger">削除</a>
        </li>
        {% empty %}
        <li>まだマイリストはありません。</li>
        {% endfor %}
      </ul>
    </div>

    <!-- アカウント操作 -->
    <div class="account-actions">
      <a href="{% url 'comparison:index' %}">トップページに戻る</a>
      <hr>
      <form method="post" action="{% url 'comparison:delete_account' %}"
        onsubmit="return confirm('本当にアカウントを削除しますか？この操作は元に戻せません。');">
        {% csrf_token %}
        <button type="submit" class="danger-button">アカウント削除</button>
      </form>
      <hr>
      <form method="post" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit">Logout</button>
      </form>
    </div>
  </div>

  <!-- 開閉用スクリプト -->
  <script>

    // 各セクションの開閉状態をローカルストレージに保存・復元する改良版
    document.addEventListener("DOMContentLoaded", function() {
      // タグ一覧
      const tagCollapsible = document.querySelector(".your_tag");
      const tagContent = document.querySelector(".tag-legend");
      // ページ読み込み時に状態を復元
      if (localStorage.getItem("tagsOpen") === "true") {
        tagContent.classList.add("open");
        tagCollapsible.classList.add("active");
      }
      // 開閉イベントを監視
      tagCollapsible.addEventListener("click", function() {
        tagContent.classList.toggle("open");
        tagCollapsible.classList.toggle("active");
        localStorage.setItem("tagsOpen", tagContent.classList.contains("open"));
      });

      // お気に入り一覧
      const collapsible = document.querySelector(".your_favorites");
      const content = document.querySelector(".favorites-section");

      // ページ読み込み時に状態を復元
      if (localStorage.getItem("favoritesOpen") === "true") {
        content.classList.add("open");
        collapsible.classList.add("active");
      }

      // 開閉イベントを監視
      collapsible.addEventListener("click", function() {
        content.classList.toggle("open");
        collapsible.classList.toggle("active");
        localStorage.setItem("favoritesOpen", content.classList.contains("open"));
      });

      // マイリスト一覧
      const mylistCollapsible = document.querySelector(".your_mylists");
      const mylistContent = document.querySelector(".mylists-section");
      // ページ読み込み時に状態を復元
      if (localStorage.getItem("mylistsOpen") === "true") {
        mylistContent.classList.add("open");
        mylistCollapsible.classList.add("active");
      }
      // 開閉イベントを監視
      mylistCollapsible.addEventListener("click", function() {
        mylistContent.classList.toggle("open");
        mylistCollapsible.classList.toggle("active");
        localStorage.setItem("mylistsOpen", mylistContent.classList.contains("open"));
      });
    });

  </script>
</body>
</html>